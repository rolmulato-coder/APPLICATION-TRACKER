const API = 'YOUR_WEB_APP_URL'; // e.g. https://script.google.com/macros/s/AKfycbx.../exec

// Elements
const appForm = document.getElementById('appForm');
const idField = document.getElementById('id');
const dateApplied = document.getElementById('dateApplied');
const jobTitle = document.getElementById('jobTitle');
const company = document.getElementById('company');
const platform = document.getElementById('platform');
const status = document.getElementById('status');
const link = document.getElementById('link');
const appsTableBody = document.querySelector('#appsTable tbody');
const search = document.getElementById('search');
const filterStatus = document.getElementById('filterStatus');

let items = [];

// Fetch list from Sheets
async function fetchList(){
  try{
    const res = await fetch(API + '?action=list');
    const data = await res.json();
    items = Array.isArray(data) ? data : [];
    renderTable();
  }catch(err){
    console.error('Fetch error', err);
    alert('Unable to load data from Google Sheets. Check your Web App URL and deployment permissions.');
  }
}

function renderTable(){
  const q = (search.value || '').toLowerCase();
  const f = filterStatus.value;
  appsTableBody.innerHTML = '';
  items
    .filter(it=>{
      if(f && (it['Status']||'') !== f) return false;
      if(!q) return true;
      return (it['Job Title']||'').toLowerCase().includes(q) ||
             (it['Company / Client']||'').toLowerCase().includes(q) ||
             (it['Platform']||'').toLowerCase().includes(q);
    })
    .sort((a,b)=> (b['ID']||0) - (a['ID']||0))
    .forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it['Date Applied']||''}</td>
        <td>${escapeHtml(it['Job Title']||'')}</td>
        <td>${escapeHtml(it['Company / Client']||'')}</td>
        <td>${escapeHtml(it['Platform']||'')}</td>
        <td>${escapeHtml(it['Status']||'')}</td>
        <td>${it['Link'] ? `<a href="${escapeAttr(it['Link'])}" target="_blank">Open</a>` : ''}</td>
        <td></td>
      `;
      const actionsTd = tr.querySelector('td:last-child');
      const editBtn = document.createElement('button'); editBtn.className='actions-btn btn-edit'; editBtn.textContent='Edit';
      const delBtn = document.createElement('button'); delBtn.className='actions-btn btn-delete'; delBtn.textContent='Delete';
      editBtn.addEventListener('click', ()=> startEdit(it));
      delBtn.addEventListener('click', ()=> doDelete(it['ID']));
      actionsTd.appendChild(editBtn); actionsTd.appendChild(delBtn);
      appsTableBody.appendChild(tr);
    });
}

function startEdit(item){
  idField.value = item['ID'] || '';
  dateApplied.value = item['Date Applied'] || '';
  jobTitle.value = item['Job Title'] || '';
  company.value = item['Company / Client'] || '';
  platform.value = item['Platform'] || '';
  status.value = item['Status'] || 'Applied';
  link.value = item['Link'] || '';
  window.scrollTo({top:0,behavior:'smooth'});
}

appForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    id: idField.value || undefined,
    'Date Applied': dateApplied.value,
    'Job Title': jobTitle.value,
    'Company / Client': company.value,
    'Platform': platform.value,
    'Status': status.value,
    'Link': link.value
  };

  try{
    if(payload.id){
      const res = await fetch(API + '?action=update', {
        method:'POST',
        body: JSON.stringify(payload),
        headers: {'Content-Type':'application/json'}
      });
      const j = await res.json();
      if(j.success) { await fetchList(); appForm.reset(); }
      else alert('Update error: ' + (j.error||'unknown'));
    } else {
      const res = await fetch(API + '?action=add', {
        method:'POST',
        body: JSON.stringify(payload),
        headers: {'Content-Type':'application/json'}
      });
      const j = await res.json();
      if(j.success){ await fetchList(); appForm.reset(); }
      else alert('Add error: ' + (j.error||'unknown'));
    }
  }catch(err){
    console.error(err); alert('Network error');
  }
});

async function doDelete(id){
  if(!confirm('Delete this entry?')) return;
  try{
    const res = await fetch(API + '?action=delete&id=' + encodeURIComponent(id));
    const j = await res.json();
    if(j.success) await fetchList();
    else alert('Delete error: ' + (j.error||'unknown'));
  }catch(err){ console.error(err); alert('Network error'); }
}

document.getElementById('resetBtn').addEventListener('click', ()=> appForm.reset());
search.addEventListener('input', renderTable);
filterStatus.addEventListener('change', renderTable);

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }

// initialize
fetchList();
